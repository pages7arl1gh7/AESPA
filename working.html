<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>平衡感调节小游戏</title>
    <!-- 引入Tailwind CSS，用于快速构建响应式界面 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入Inter字体，提升可读性 -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@404&display=swap" rel="stylesheet">
    <style>
        /* 基础样式，针对中老年用户增加字体大小和粗细 */
        body {
            font-family: 'Inter', sans-serif;
            font-size: 2.8rem;
            font-weight: 400;
            line-height: 1.6;
            background-color: #ffe4ef; /* a little pink background */
            color: #60a5fa; /* LIGHT BLUE 字体 */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* 标题字体加粗 */
        h1, h2, h3 {
            font-weight: 500;
            font-size: 6.4rem;
            color: #60a5fa; /* LIGHT BLUE 标题 */
        }
        /* 页面内容容器 */
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem;
            background-color: #ffe4ef; /* a little pink background for container */
        }
        /* 模态框基础样式 */
        .modal {
            display: none; /* 默认隐藏 */
            position: fixed; /* 固定定位 */
            z-index: 1000; /* 叠放顺序在最上层 */
            left: 0;
            top: 0;
            width: 100%; /* 全宽 */
            height: 100%; /* 全高 */
            overflow: auto; /* 允许滚动 */
            background-color: rgba(0,0,0,0.6); /* 半透明黑色背景 */
            justify-content: center; /* 水平居中 */
            align-items: center; /* 垂直居中 */
        }
        /* 模态框内容样式 */
        .modal-content {
            background-color: #ffe4ef; /* a little pink background for modal */
            margin: auto;
            padding: 1.5rem;
            border-radius: 3rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            max-width: 90%;
            width: 1200px;
            text-align: center;
            position: relative;
            color: #60a5fa;
            font-size: 1.5rem;
        }
        /* 页面切换容器样式 */
        .page {
            display: none; /* 默认隐藏 */
        }
        /* 头部样式 */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background-color: #ffe4ef; /* a little pink background for header */
            border-bottom-left-radius: 1rem;
            border-bottom-right-radius: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        /* 按钮样式 */
        .btn {
            background-color: #f59e42;
            color: #60a5fa;
            padding: 1.5rem 3rem;
            border-radius: 1.5rem;
            font-weight: bold;
            transition: background-color 0.3s ease;
            cursor: pointer;
            border: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            font-size: 4rem;
        }
        .btn:hover {
            background-color: #ea580c;
        }
        .btn:active {
            transform: translateY(1px);
            background-color: #c2410c;
        }
        /* 输入框和下拉框样式 */
        input, select {
            padding: 1.5rem;
            border: 1px solid #ccc;
            border-radius: 1rem;
            width: 100%;
            max-width: 600px;
            font-size: 4rem;
            margin-bottom: 2rem;
            box-sizing: border-box;
            color: #60a5fa;
        }
        label {
            display: block;
            margin-bottom: 1rem;
            font-weight: bold;
            text-align: left;
            font-size: 4rem;
            color: #60a5fa;
        }
        /* 视频容器布局 */
        .video-container {
            display: grid;
            grid-template-columns: 2fr 1fr; /* 标准动作视频区域更大，用户视频区域较小 */
            gap: 2rem;
            margin-top: 3rem;
            background-color: #ffe4ef; /* a little pink background for video container */
            padding: 2rem;
            border-radius: 2rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            color: #60a5fa;
            font-size: 4rem;
        }
        /* 视频包裹器，用于保持视频宽高比 */
        .video-wrapper {
            position: relative;
            width: 100%;
            padding-top: 75%; /* 4:3 宽高比 (高度 / 宽度 * 100) */
            background-color: #ffe4ef; /* a little pink background for video wrapper */
            border-radius: 1.5rem;
            overflow: hidden; /* 隐藏超出部分 */
        }
        /* 视频和Canvas覆盖样式 */
        .video-wrapper video, .video-wrapper canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain; /* 确保视频内容适配容器 */
        }
        /* 倒计时文本样式 */
        .countdown {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24rem;
            color: #60a5fa;
            z-index: 10;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            font-weight: bold;
        }
        /* 移动端响应式调整 */
        @media (max-width: 768px) {
            body {
                font-size: 3rem;
            }
            h1, h2, h3 {
                font-size: 4rem;
            }
            .btn, input, select, label {
                font-size: 3rem;
            }
            .countdown {
                font-size: 12rem;
            }
        }
    </style>
</head>
<body>

    <!-- 网页头部区域 -->
    <div class="header">
        <h1 class="text-2xl font-bold text-indigo-700" id="appTitle">平衡感调节小游戏</h1>
        <div class="language-selector">
            <label for="languageSelect" class="sr-only">选择语言</label>
            <select id="languageSelect" class="p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <option value="zh-CN">简体中文</option>
                <option value="en-US">English</option>
            </select>
        </div>
    </div>

    <!-- 免责声明模态框 (默认显示) -->
    <div id="disclaimerModal" class="modal flex">
        <div class="modal-content">
            <h2 class="text-3xl font-extrabold mb-6 text-red-600" id="disclaimerTitle">免责声明</h2>
            <p class="mb-6 leading-relaxed" id="disclaimerText">
                本网站的内容不构成专业的医疗建议，请根据自己的身体状况选择适当的活动。
                本网站提出的建议仅作为参考并且不构成任何医疗建议。
                如果感到身体不适，请及时就医。
                本网站不会收集您的个人数据也不会保存任何视频。
                您在本网站中输入的任何信息都只是为了推荐更加适合您的小游戏而使用，它们不会被上传到我们的服务器。
            </p>
            <button id="confirmDisclaimerBtn" class="btn text-xl">我已阅读并同意</button>
        </div>
    </div>

    <!-- 用户信息输入页面 (点击免责声明确认后显示) -->
    <div id="userInfoPage" class="page container py-8">
        <h2 class="text-3xl font-bold mb-8 text-center text-indigo-700" id="userInfoTitle">请输入您的信息</h2>
        <div class="max-w-md mx-auto bg-white p-8 rounded-xl shadow-lg">
            <div class="mb-4">
                <label for="ageInput" id="labelAge">年龄:</label>
                <input type="number" id="ageInput" placeholder="请输入您的年龄" class="w-full">
            </div>
            <div class="mb-4">
                <label for="genderSelect" id="labelGender">性别:</label>
                <select id="genderSelect" class="w-full">
                    <option value="" disabled selected id="genderPlaceholder">请选择性别</option>
                    <option value="male" id="genderMale">男</option>
                    <option value="female" id="genderFemale">女</option>
                </select>
            </div>
            <div class="mb-4">
                <label for="weightInput" id="labelWeight">体重 (kg):</label>
                <input type="number" id="weightInput" placeholder="请输入您的体重 (kg)" step="0.1" class="w-full">
            </div>
            <div class="mb-6">
                <label for="heightInput" id="labelHeight">身高 (m):</label>
                <input type="number" id="heightInput" placeholder="请输入您的身高 (m)" step="0.01" class="w-full">
            </div>
            <button id="submitUserInfoBtn" class="btn w-full text-xl">提交</button>
        </div>
    </div>

    <!-- 游戏主页面 (输入用户信息后显示) -->
    <div id="gamePage" class="page container py-8">
        <h2 class="text-3xl font-bold mb-6 text-center text-indigo-700" id="gamePageTitle">平衡感调节游戏</h2>

        <div class="flex flex-col md:flex-row justify-center items-center md:items-start gap-6 mb-6 bg-white p-6 rounded-xl shadow-lg">
            <div class="w-full md:w-1/3">
                <label for="difficultySelect" class="block mb-2 font-bold" id="labelDifficulty">选择游戏难度:</label>
                <select id="difficultySelect" class="p-3 border rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <option value="high" id="difficultyHigh">高</option>
                    <option value="mid" id="difficultyMid">中</option>
                    <option value="easy" id="difficultyEasy">低</option>
                </select>
            </div>
            <div class="w-full md:w-2/3 text-center md:text-right">
                <p class="text-2xl font-bold mb-2" id="currentScoreLabel">当前平均得分:</p>
                <p id="averageScoreDisplay" class="text-4xl font-extrabold text-green-600">0</p>
            </div>
        </div>

        <div class="video-container">
            <!-- 标准动作视频区域 -->
            <div class="video-wrapper relative">
                <h3 class="absolute top-2 left-2 z-10 text-white text-lg font-bold bg-black bg-opacity-50 px-2 py-1 rounded" id="standardVideoLabel">标准动作</h3>
                <video id="standardVideo" autoplay loop muted playsinline></video>
                <canvas id="standardCanvas" class="absolute top-0 left-0"></canvas>
            </div>
            <!-- 用户实时视频及姿态分析区域 -->
            <div class="video-wrapper relative">
                <h3 class="absolute top-2 left-2 z-10 text-white text-lg font-bold bg-black bg-opacity-50 px-2 py-1 rounded" id="userVideoLabel">您的实时动作</h3>
                <video id="userVideo" autoplay playsinline></video>
                <canvas id="userCanvas" class="absolute top-0 left-0"></canvas>
                <div id="countdownDisplay" class="countdown hidden">3</div>
            </div>
        </div>

        <div class="text-center mt-8">
            <button id="startGameBtn" class="btn text-2xl px-8 py-4">开始游戏</button>
        </div>
    </div>

    <!-- 游戏结束模态框 -->
    <div id="gameOverModal" class="modal flex">
        <div class="modal-content">
            <h2 class="text-3xl font-extrabold mb-6 text-indigo-700" id="gameOverTitle">游戏结束！</h2>
            <p class="text-2xl mb-4" id="finalScoreText">您的最终得分:</p>
            <p id="finalScoreDisplay" class="text-5xl font-extrabold text-purple-600 mb-6">0</p>
            <h3 class="text-xl font-bold mb-3" id="adviceTitle">营养补充建议:</h3>
            <p id="nutritionAdvice" class="mb-6 leading-relaxed">根据您的表现，建议...</p>
            <button id="restartGameBtn" class="btn text-xl">重新开始</button>
        </div>
    </div>

    <script type="module">
        // 导入MediaPipe PoseLandmarker、FilesetResolver和DrawingUtils模块
        import { PoseLandmarker, FilesetResolver, DrawingUtils } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0";

        // 多语言翻译字典
        const translations = {
            'zh-CN': {
                appTitle: '平衡感调节小游戏',
                disclaimerTitle: '免责声明',
                disclaimerText: '本网站的内容不构成专业的医疗建议，请根据自己的身体状况选择适当的活动。本网站提出的建议仅作为参考并且不构成任何医疗建议。如果感到身体不适，请及时就医。本网站不会收集您的个人数据也不会保存任何视频。您在本网站中输入的任何信息都只是为了推荐更加适合您的小游戏而使用，它们不会被上传到我们的服务器。',
                confirmDisclaimerBtn: '我已阅读并同意',
                userInfoTitle: '请输入您的信息',
                labelAge: '年龄:',
                ageInputPlaceholder: '请输入您的年龄',
                labelGender: '性别:',
                genderPlaceholder: '请选择性别',
                genderMale: '男',
                genderFemale: '女',
                labelWeight: '体重 (kg):',
                weightInputPlaceholder: '请输入您的体重 (kg)',
                labelHeight: '身高 (m):',
                heightInputPlaceholder: '请输入您的身高 (m)',
                submitUserInfoBtn: '提交',
                gamePageTitle: '平衡感调节游戏',
                labelDifficulty: '选择游戏难度:',
                difficultyHigh: '高',
                difficultyMid: '中',
                difficultyEasy: '低',
                currentScoreLabel: '当前平均得分:',
                standardVideoLabel: '标准动作',
                userVideoLabel: '您的实时动作',
                startGameBtn: '开始游戏',
                endGameBtn: '结束游戏',
                gameOverTitle: '游戏结束！',
                finalScoreText: '您的最终得分:',
                adviceTitle: '营养补充建议:',
                nutritionAdviceLow: '您的表現還有提升空間。建議多補充蛋白質和鈣質，例如牛奶、豆腐、魚肉，以增強肌肉和骨骼健康。同時，可以嘗試低強度的平衡練習。',
                nutritionAdviceLowSupplements: [
                    '維特健靈-活關素特強特效膠囊（90粒）',
                    'Move Free 益節 氨糖軟骨素',
                    'Swisse 關節健康片',
                    'Blackmores 關節靈',
                    '健力多 氨糖軟骨素鈣片',
                    'Kirkland Glucosamine HCl with MSM',
                    'Nature Made TripleFlex',
                    'Schiff Glucosamine Plus MSM',
                    'Puritan’s Pride Glucosamine Chondroitin MSM',
                    '健安喜(GNC) 關節健康配方'
                ],
                nutritionAdviceMid: '您的關節需要更多呵護，建議補充關節靈活相關保健品，並適度運動。',
                nutritionAdviceMidSupplements: [
                    '川御一 關節の御守',
                    'Sato 佐藤製藥 關節守護',
                    'ORIHIRO 葡萄糖胺',
                    '日本小林製藥 關節靈',
                    '善存 關節健康配方',
                    '森下仁丹 關節靈',
                    'DHC 關節靈活片',
                    '永信 關節寶',
                    '台塑生醫 關健素',
                    '白蘭氏 關鍵活力膠囊'
                ],
                nutritionAdviceHigh: '您的表現非常出色！請繼續保持良好的運動習慣和均衡的飲食。',
                nutritionAdviceHighSupplements: [
                    '醫之選-液關健',
                    '安美露 關節舒緩液',
                    '葡萄王 關健寶',
                    '康健生技 關健飲',
                    '台塑生醫 關健飲',
                    '善存 關鍵活力飲',
                    '白蘭氏 關鍵飲',
                    'Swisse 關節健康飲',
                    'Move Free 關節飲',
                    'GNC 關節健康飲'
                ],
                restartGameBtn: '重新开始',
                cameraAccessError: '无法访问摄像头，请检查权限设置。',
                invalidInputError: '请填写有效的年龄、体重和身高！'
            },
            'en-US': {
                appTitle: 'Balance Training Mini-Games',
                disclaimerTitle: 'Disclaimer',
                disclaimerText: 'The content of this website does not constitute professional medical advice. Please choose appropriate activities based on your physical condition. The suggestions provided by this website are for reference only and do not constitute any medical advice. If you feel unwell, please seek medical attention promptly. This website does not collect your personal data or save any videos. Any information you enter on this website is solely for the purpose of recommending more suitable mini-games for you, and it will not be uploaded to our servers.',
                confirmDisclaimerBtn: 'I have read and agree',
                userInfoTitle: 'Please Enter Your Information',
                labelAge: 'Age:',
                ageInputPlaceholder: 'Enter your age',
                labelGender: 'Gender:',
                genderPlaceholder: 'Select Gender',
                genderMale: 'Male',
                genderFemale: 'Female',
                labelWeight: 'Weight (kg):',
                weightInputPlaceholder: 'Enter your weight (kg)',
                labelHeight: 'Height (m):',
                heightInputPlaceholder: 'Enter your height (m)',
                submitUserInfoBtn: 'Submit',
                gamePageTitle: 'Balance Training Game',
                labelDifficulty: 'Select Game Difficulty:',
                difficultyHigh: 'High',
                difficultyMid: 'Mid',
                difficultyEasy: 'Low',
                currentScoreLabel: 'Current Average Score:',
                standardVideoLabel: 'Standard Movement',
                userVideoLabel: 'Your Live Movement',
                startGameBtn: 'Start Game',
                endGameBtn: 'End Game',
                gameOverTitle: 'Game Over!',
                finalScoreText: 'Your Final Score:',
                adviceTitle: 'Nutritional Advice:',
                nutritionAdviceLow: 'Your performance has room for improvement. It is recommended to supplement protein and calcium, such as milk, tofu, and fish, to strengthen muscle and bone health. You can also try low-intensity balance exercises.',
                nutritionAdviceLowSupplements: [
                    'Vita Green VitaJoint Extra Strength Capsules (90 capsules)',
                    'Move Free Joint Health',
                    'Swisse Joint Health Tablets',
                    'Blackmores Joint Formula',
                    'Caltrate Joint Health',
                    'Kirkland Glucosamine HCl with MSM',
                    'Nature Made TripleFlex',
                    'Schiff Glucosamine Plus MSM',
                    'Puritan’s Pride Glucosamine Chondroitin MSM',
                    'GNC Joint Health Formula'
                ],
                nutritionAdviceMid: 'Your joints need more care. Consider joint flexibility supplements and moderate exercise.',
                nutritionAdviceMidSupplements: [
                    'Kawaguchi Joint Guardian',
                    'Sato Joint Support',
                    'ORIHIRO Glucosamine',
                    'Kobayashi Joint Formula',
                    'Centrum Joint Health',
                    'Morishita Jintan Joint',
                    'DHC Joint Tablets',
                    'Yung Shin Joint Care',
                    'Formosa Biomedical Joint Formula',
                    'Brand’s Joint Vitality Capsules'
                ],
                nutritionAdviceHigh: 'Excellent performance! Please continue to maintain good exercise habits and a balanced diet.',
                nutritionAdviceHighSupplements: [
                    'EZZ Liquid Joint',
                    'Amrutanjan Joint Relief Liquid',
                    'Grape King Joint Care',
                    'Health Bio Joint Drink',
                    'Formosa Biomedical Joint Drink',
                    'Centrum Joint Vitality Drink',
                    'Brand’s Joint Drink',
                    'Swisse Joint Health Drink',
                    'Move Free Joint Drink',
                    'GNC Joint Health Drink'
                ],
                restartGameBtn: 'Restart Game',
                cameraAccessError: 'Unable to access camera, please check permissions.',
                invalidInputError: 'Please enter valid age, weight, and height!'
            }
        };

        let currentLanguage = 'zh-CN'; // 默认语言为中文

        // 根据当前语言更新所有文本内容
        function updateLanguage() {
            // 更新通用文本
            document.getElementById('appTitle').textContent = translations[currentLanguage].appTitle;
            // 更新免责声明模态框文本
            document.getElementById('disclaimerTitle').textContent = translations[currentLanguage].disclaimerTitle;
            document.getElementById('disclaimerText').textContent = translations[currentLanguage].disclaimerText;
            document.getElementById('confirmDisclaimerBtn').textContent = translations[currentLanguage].confirmDisclaimerBtn;

            // 更新用户信息页面文本
            document.getElementById('userInfoTitle').textContent = translations[currentLanguage].userInfoTitle;
            document.getElementById('labelAge').textContent = translations[currentLanguage].labelAge;
            document.getElementById('ageInput').placeholder = translations[currentLanguage].ageInputPlaceholder;
            document.getElementById('labelGender').textContent = translations[currentLanguage].labelGender;
            document.getElementById('genderPlaceholder').textContent = translations[currentLanguage].genderPlaceholder;
            document.getElementById('genderMale').textContent = translations[currentLanguage].genderMale;
            document.getElementById('genderFemale').textContent = translations[currentLanguage].genderFemale;
            document.getElementById('labelWeight').textContent = translations[currentLanguage].labelWeight;
            document.getElementById('weightInput').placeholder = translations[currentLanguage].weightInputPlaceholder;
            document.getElementById('labelHeight').textContent = translations[currentLanguage].labelHeight;
            document.getElementById('heightInput').placeholder = translations[currentLanguage].heightInputPlaceholder;
            document.getElementById('submitUserInfoBtn').textContent = translations[currentLanguage].submitUserInfoBtn;

            // 更新游戏页面文本
            document.getElementById('gamePageTitle').textContent = translations[currentLanguage].gamePageTitle;
            document.getElementById('labelDifficulty').textContent = translations[currentLanguage].labelDifficulty;
            document.getElementById('difficultyHigh').textContent = translations[currentLanguage].difficultyHigh;
            document.getElementById('difficultyMid').textContent = translations[currentLanguage].difficultyMid;
            document.getElementById('difficultyEasy').textContent = translations[currentLanguage].difficultyEasy;
            document.getElementById('currentScoreLabel').textContent = translations[currentLanguage].currentScoreLabel;
            document.getElementById('standardVideoLabel').textContent = translations[currentLanguage].standardVideoLabel;
            document.getElementById('userVideoLabel').textContent = translations[currentLanguage].userVideoLabel;
            document.getElementById('startGameBtn').textContent = translations[currentLanguage].startGameBtn;

            // 更新游戏结束模态框文本
            document.getElementById('gameOverTitle').textContent = translations[currentLanguage].gameOverTitle;
            document.getElementById('finalScoreText').textContent = translations[currentLanguage].finalScoreText;
            document.getElementById('adviceTitle').textContent = translations[currentLanguage].adviceTitle;
            document.getElementById('nutritionAdvice').textContent = translations[currentLanguage].nutritionAdviceLow; // 初始设置为低档建议，后续会更新
            document.getElementById('restartGameBtn').textContent = translations[currentLanguage].restartGameBtn;

            // 根据游戏状态更新开始/结束按钮文本
            if (isGameRunning) {
                document.getElementById('startGameBtn').textContent = translations[currentLanguage].endGameBtn;
            } else {
                document.getElementById('startGameBtn').textContent = translations[currentLanguage].startGameBtn;
            }
        }

        // 语言切换下拉框事件监听
        document.getElementById('languageSelect').addEventListener('change', (event) => {
            currentLanguage = event.target.value;
            updateLanguage();
        });

        // --- 页面导航逻辑 ---
        const disclaimerModal = document.getElementById('disclaimerModal');
        const userInfoPage = document.getElementById('userInfoPage');
        const gamePage = document.getElementById('gamePage');
        const gameOverModal = document.getElementById('gameOverModal');

        // 显示指定页面，隐藏其他页面
        function showPage(pageElement) {
            const pages = [userInfoPage, gamePage, disclaimerModal, gameOverModal]; // 所有可切换的“页面”
            pages.forEach(page => page.style.display = 'none'); // 先隐藏所有页面
            pageElement.style.display = 'flex'; // 对于模态框使用flex使其居中
            if (pageElement === userInfoPage || pageElement === gamePage) {
                pageElement.style.display = 'block'; // 对于常规页面使用block
            }
        }

        // 网页加载完成后，首先显示免责声明模态框并初始化语言
        window.onload = async () => {
            updateLanguage(); // 设置初始语言
            showPage(disclaimerModal);
            // 异步创建PoseLandmarker实例，确保在DOM加载和模块解析完成后进行
            // 使用 setTimeout 0 延迟，确保所有模块加载完毕
            setTimeout(async () => {
                await createPoseLandmarker();
            }, 0);
        };

        // 免责声明确认按钮点击事件
        document.getElementById('confirmDisclaimerBtn').addEventListener('click', () => {
            showPage(userInfoPage); // 显示用户信息页面
        });

        // --- 用户信息收集与BMI计算 ---
        let userAge, userWeight, userHeight;

        // 提交用户信息按钮点击事件
        document.getElementById('submitUserInfoBtn').addEventListener('click', () => {
            userAge = parseInt(document.getElementById('ageInput').value);
            userWeight = parseFloat(document.getElementById('weightInput').value);
            userHeight = parseFloat(document.getElementById('heightInput').value);

            // 验证输入是否有效
            if (isNaN(userAge) || isNaN(userWeight) || isNaN(userHeight) || userAge <= 0 || userWeight <= 0 || userHeight <= 0) {
                // 使用自定义弹窗或更友好的UI提示代替alert
                alert(translations[currentLanguage].invalidInputError);
                return;
            }

            // 计算BMI
            const bmi = userWeight / (userHeight * userHeight);
            let defaultDifficulty = 'mid'; // 默认难度为中等

            // 根据年龄和BMI设置默认游戏难度
            if (userAge > 70) {
                defaultDifficulty = 'easy'; // 70岁以上，默认低难度
            } else if (bmi < 18.5) { // 偏瘦
                defaultDifficulty = 'high';
            } else if (bmi >= 18.5 && bmi < 24) { // 正常体重 (参考亚洲标准)
                defaultDifficulty = 'high';
            } else if (bmi >= 24 && bmi < 28) { // 超重
                defaultDifficulty = 'mid';
            } else if (bmi >= 28) { // 肥胖
                defaultDifficulty = 'easy';
            }

            document.getElementById('difficultySelect').value = defaultDifficulty; // 设置下拉框的默认值
            currentStandardVideo = `assets/${defaultDifficulty}.mp4`; // 设置标准视频路径
            document.getElementById('standardVideo').src = currentStandardVideo; // 加载标准视频

            showPage(gamePage); // 显示游戏页面
            setupCamera(); // 设置并启动摄像头
        });

        // --- 游戏核心逻辑变量 ---
        const userVideo = document.getElementById('userVideo');
        const standardVideo = document.getElementById('standardVideo');
        const userCanvas = document.getElementById('userCanvas');
        const standardCanvas = document.getElementById('standardCanvas');
        const countdownDisplay = document.getElementById('countdownDisplay');
        const averageScoreDisplay = document.getElementById('averageScoreDisplay');
        const startGameBtn = document.getElementById('startGameBtn');
        const difficultySelect = document.getElementById('difficultySelect');

        let userVideoCtx = userCanvas.getContext('2d');
        let standardVideoCtx = standardCanvas.getContext('2d');
        let poseLandmarker; // MediaPipe PoseLandmarker实例
        let runningMode = "VIDEO"; // MediaPipe运行模式
        let lastVideoTime = -1; // 记录上一帧视频时间，避免重复处理
        let userDrawingUtils; // 用于在用户视频Canvas上绘制
        let standardDrawingUtils; // 用于在标准视频Canvas上绘制
        let currentStandardVideo = 'assets/mid.mp4'; // 当前标准视频路径，默认中等难度
        let isGameRunning = false; // 游戏是否正在进行
        let animationFrameId; // requestAnimationFrame的ID，用于控制动画循环
        let countdownTimer; // 倒计时定时器
        let totalScore = 0; // 总得分
        let frameCount = 0; // 已处理的帧数
        let enablePoseDetection = false; // 是否启用姿态检测（在倒计时结束后开启）

        // --- MediaPipe PoseLandmarker 初始化 ---
        async function createPoseLandmarker() {
            console.log("Attempting to create PoseLandmarker...");
            // 从CDN加载MediaPipe的WASM文件
            const vision = await FilesetResolver.forVisionTasks(
                "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm"
            );
            console.log("FilesetResolver for vision tasks loaded.");
            // 创建PoseLandmarker实例，加载轻量级模型，并设置GPU加速
            poseLandmarker = await PoseLandmarker.createFromOptions(vision, {
                baseOptions: {
                    modelAssetPath: `https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task`,
                    delegate: "GPU"
                },
                runningMode: runningMode,
                numPoses: 1 // 只检测一个人体
            });
            console.log("PoseLandmarker loaded successfully.");
        }

        // --- 摄像头设置 ---
        async function setupCamera() {
            // 检查浏览器是否支持getUserMedia
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert(translations[currentLanguage].cameraAccessError);
                return;
            }

            try {
                // 请求访问用户摄像头
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                userVideo.srcObject = stream; // 将视频流设置到userVideo元素
                // 视频数据加载完成后，设置Canvas尺寸并获取2D上下文和绘图工具
                userVideo.addEventListener('loadeddata', () => {
                    userCanvas.width = userVideo.videoWidth;
                    userCanvas.height = userVideo.videoHeight;
                    userVideoCtx = userCanvas.getContext('2d');
                    userDrawingUtils = new DrawingUtils(userVideoCtx);
                    console.log("User video loaded and canvas sized.");
                    userVideo.play(); // 确保用户视频自动播放
                });
            } catch (error) {
                console.error('Error accessing camera:', error);
                alert(translations[currentLanguage].cameraAccessError);
            }
        }

        // --- 标准视频设置 ---
        // 游戏难度下拉框改变时，更新标准视频源
        difficultySelect.addEventListener('change', () => {
            if (!isGameRunning) { // 只有在游戏未运行时才能切换视频
                currentStandardVideo = `assets/${difficultySelect.value}.mp4`;
                standardVideo.src = currentStandardVideo;
            }
        });

        // 标准视频数据加载完成后，设置Canvas尺寸并获取2D上下文和绘图工具
        standardVideo.addEventListener('loadeddata', () => {
            standardCanvas.width = standardVideo.videoWidth;
            standardCanvas.height = standardVideo.videoHeight;
            standardVideoCtx = standardCanvas.getContext('2d');
            standardDrawingUtils = new DrawingUtils(standardVideoCtx);
            console.log("Standard video loaded and canvas sized.");
        });
        // 保证canvas在视频尺寸变化时也同步
        standardVideo.addEventListener('resize', () => {
            standardCanvas.width = standardVideo.videoWidth;
            standardCanvas.height = standardVideo.videoHeight;
        });

        // --- 姿态检测循环 ---
        async function predictWebcam() {
            // 如果PoseLandmarker未加载或姿态检测未启用，则继续下一帧动画
            if (!poseLandmarker || !enablePoseDetection) {
                animationFrameId = requestAnimationFrame(predictWebcam);
                return;
            }

            let userResults = null;
            // 仅当用户视频时间更新时才进行检测
            if (userVideo.currentTime !== lastVideoTime) {
                lastVideoTime = userVideo.currentTime;
                // 对用户视频进行姿态检测
                userResults = poseLandmarker.detectForVideo(userVideo, performance.now());
            }

            let standardResults = null;
            // 只有当标准视频正在播放时才进行检测
            if (standardVideo.currentTime > 0 && !standardVideo.paused && !standardVideo.ended) {
                // 从当前标准视频帧创建ImageBitmap，以便MediaPipe处理
                const standardImageBitmap = await createImageBitmap(standardVideo);
                // 对标准视频帧进行姿态检测
                standardResults = poseLandmarker.detectForVideo(standardImageBitmap, performance.now());
            }

            // 清空Canvas，准备绘制新帧
            userVideoCtx.clearRect(0, 0, userCanvas.width, userCanvas.height);
            standardVideoCtx.clearRect(0, 0, standardCanvas.width, standardCanvas.height);

            // 绘制用户姿态骨骼点和连接线
            if (userResults && userResults.landmarks && userResults.landmarks.length > 0) {
                for (const landmark of userResults.landmarks) {
                    userDrawingUtils.drawConnectors(landmark, PoseLandmarker.POSE_CONNECTIONS, { color: "#00FF00", lineWidth: 4 }); // 绿色连接线
                    userDrawingUtils.drawLandmarks(landmark, { radius: 5, color: "#FF0000" }); // 红色骨骼点
                }
            }

            // 绘制标准姿态骨骼点和连接线
            if (standardResults && standardResults.landmarks && standardResults.landmarks.length > 0) {
                for (const landmark of standardResults.landmarks) {
                    standardDrawingUtils.drawConnectors(landmark, PoseLandmarker.POSE_CONNECTIONS, { color: "#00FFFF", lineWidth: 4 }); // 青色连接线
                    standardDrawingUtils.drawLandmarks(landmark, { radius: 5, color: "#FF00FF" }); // 紫色骨骼点
                }
            }

            // 如果用户和标准视频都检测到了姿态，则计算并显示得分
            if (userResults && userResults.landmarks && userResults.landmarks.length > 0 &&
                standardResults && standardResults.landmarks && standardResults.landmarks.length > 0) {
                calculateAndDisplayScore(userResults.landmarks[0], standardResults.landmarks[0]);
            }

            // 继续下一帧动画循环
            animationFrameId = requestAnimationFrame(predictWebcam);
        }

        // --- 得分计算逻辑 (余弦相似度) ---
        // 定义用于计算余弦相似度的关键关节对（骨骼向量）
        // 具体的关节索引可以参考MediaPipe Pose的官方文档
        const JOINT_PAIRS = [
            // 左右臂
            [11, 13], // 左肩到左肘
            [13, 15], // 左肘到左腕
            [12, 14], // 右肩到右肘
            [14, 16], // 右肘到右腕
            // 左右腿
            [23, 25], // 左髋到左膝
            [25, 27], // 左膝到左踝
            [24, 26], // 右髋到右膝
            [26, 28], // 右膝到右踝
            // 躯干部分
            [11, 23], // 左肩到左髋
            [12, 24], // 右肩到右髋
            [11, 12], // 双肩（用于水平对齐）
            [23, 24]  // 双髋（用于水平对齐）
        ];

        // 获取两点之间的向量
        function getVector(p1, p2) {
            return { x: p2.x - p1.x, y: p2.y - p1.y, z: p2.z - p1.z };
        }

        // 计算向量点积
        function dotProduct(v1, v2) {
            return v1.x * v2.x + v1.y * v2.y + v1.z * v2.z;
        }

        // 计算向量的模（长度）
        function magnitude(v) {
            return Math.sqrt(v.x * v.x + v.y * v.y + v.z - v.z);
        }

        // 计算两个向量的余弦相似度
        function cosineSimilarity(v1, v2) {
            const mag1 = magnitude(v1);
            const mag2 = magnitude(v2);
            if (mag1 === 0 || mag2 === 0) return 0; // 避免除以零
            // 余弦相似度公式：(v1 . v2) / (|v1| * |v2|)
            return dotProduct(v1, v2) / (mag1 * mag2);
        }

        // 计算并显示当前帧得分
        function calculateAndDisplayScore(userLandmarks, standardLandmarks) {
            let frameScore = 0; // 当前帧的总相似度
            let validVectorPairs = 0; // 有效的向量对数量

            // 遍历所有定义的关节对
            for (const [idx1, idx2] of JOINT_PAIRS) {
                const userP1 = userLandmarks[idx1];
                const userP2 = userLandmarks[idx2];
                const standardP1 = standardLandmarks[idx1];
                const standardP2 = standardLandmarks[idx2];

                // 确保关键点都存在
                if (userP1 && userP2 && standardP1 && standardP2) {
                    const userVec = getVector(userP1, userP2);
                    const standardVec = getVector(standardP1, standardP2);

                    const similarity = cosineSimilarity(userVec, standardVec);
                    // 余弦相似度范围是-1到1。为了方便计分，将其映射到0到1的范围：(similarity + 1) / 2
                    frameScore += (similarity + 1) / 2;
                    validVectorPairs++;
                }
            }

            if (validVectorPairs > 0) {
                const averageSimilarity = frameScore / validVectorPairs; // 计算平均相似度
                const score = Math.round(averageSimilarity * 100); // 将相似度转换为0-100的得分
                totalScore += score; // 累加总分
                frameCount++; // 增加帧计数
                // 更新显示当前平均得分
                averageScoreDisplay.textContent = Math.round(totalScore / frameCount);
            }
        }

        // --- 游戏开始/结束逻辑 ---
        startGameBtn.addEventListener('click', () => {
            if (!isGameRunning) {
                startGame(); // 如果游戏未开始，则启动游戏
            } else {
                endGame(); // 如果游戏正在进行，则结束游戏
            }
        });

        // 启动游戏流程
        async function startGame() {
            // 检查MediaPipe模型是否加载完成
            if (!poseLandmarker) {
                alert('MediaPipe模型正在加载中，请稍候...');
                return;
            }
            // 检查摄像头是否已成功访问
            if (!userVideo.srcObject) {
                alert(translations[currentLanguage].cameraAccessError);
                return;
            }

            isGameRunning = true;
            startGameBtn.textContent = translations[currentLanguage].endGameBtn; // 更改按钮文本为“结束游戏”
            totalScore = 0; // 重置总分
            frameCount = 0; // 重置帧计数
            averageScoreDisplay.textContent = '0'; // 重置显示得分
            difficultySelect.disabled = true; // 游戏进行中禁用难度选择

            // 显示倒计时
            countdownDisplay.classList.remove('hidden');
            let count = 3;
            countdownDisplay.textContent = count;
            countdownTimer = setInterval(() => {
                count--;
                countdownDisplay.textContent = count;
                if (count === 0) {
                    clearInterval(countdownTimer); // 清除倒计时定时器
                    countdownDisplay.classList.add('hidden'); // 隐藏倒计时
                    startPoseDetection(); // 开始姿态检测
                }
            }, 1000);
        }

        // 实际开始姿态检测和视频播放
        function startPoseDetection() {
            standardVideo.play(); // 播放标准视频
            userVideo.play(); // 确保用户摄像头视频播放
            enablePoseDetection = true; // 启用姿态检测
            // 启动MediaPipe预测循环
            animationFrameId = requestAnimationFrame(predictWebcam);
            // 监听标准视频播放结束事件，自动结束游戏
            standardVideo.addEventListener('ended', endGame, { once: true });
        }

        // 结束游戏流程
        function endGame() {
            isGameRunning = false;
            enablePoseDetection = false; // 禁用姿态检测
            startGameBtn.textContent = translations[currentLanguage].startGameBtn; // 恢复按钮文本为“开始游戏”
            difficultySelect.disabled = false; // 重新启用难度选择

            clearInterval(countdownTimer); // 清除倒计时
            cancelAnimationFrame(animationFrameId); // 取消动画帧循环

            userVideo.pause(); // 暂停用户视频
            standardVideo.pause(); // 暂停标准视频
            standardVideo.currentTime = 0; // 标准视频重置到开头

            // 清空Canvas内容
            userVideoCtx.clearRect(0, 0, userCanvas.width, userCanvas.height);
            standardVideoCtx.clearRect(0, 0, standardCanvas.width, standardCanvas.height);

            showGameOverModal(); // 显示游戏结束模态框
        }

        // 显示游戏结束模态框并提供建议
        function showGameOverModal() {
            // 计算最终平均得分
            const finalScore = frameCount > 0 ? Math.round(totalScore / frameCount) : 0;
            document.getElementById('finalScoreDisplay').textContent = finalScore;

            let adviceText = '';
            let supplement = '';
            // 根據分數區間推薦不同保健品
            if (finalScore < 50) {
                const supplements = translations[currentLanguage].nutritionAdviceLowSupplements;
                supplement = supplements[Math.floor(Math.random() * supplements.length)];
                adviceText = `${translations[currentLanguage].nutritionAdviceLow}<br><strong style='color:#d97706;'>推薦：${supplement}</strong>`;
                document.getElementById('nutritionAdvice').innerHTML = adviceText;
            } else if (finalScore >= 50 && finalScore < 150) {
                const supplements = translations[currentLanguage].nutritionAdviceMidSupplements;
                supplement = supplements[Math.floor(Math.random() * supplements.length)];
                adviceText = `${translations[currentLanguage].nutritionAdviceMid}<br><strong style='color:#2563eb;'>推薦：${supplement}</strong>`;
                document.getElementById('nutritionAdvice').innerHTML = adviceText;
            } else if (finalScore >= 150) {
                const supplements = translations[currentLanguage].nutritionAdviceHighSupplements;
                supplement = supplements[Math.floor(Math.random() * supplements.length)];
                adviceText = `${translations[currentLanguage].nutritionAdviceHigh}<br><strong style='color:#059669;'>推薦：${supplement}</strong>`;
                document.getElementById('nutritionAdvice').innerHTML = adviceText;
            }
            document.getElementById('nutritionAdvice').innerHTML = adviceText;
            showPage(gameOverModal); // 显示游戏结束模态框
        }

        // 重新开始游戏按钮点击事件
        document.getElementById('restartGameBtn').addEventListener('click', () => {
            showPage(gamePage); // 返回游戏主页面
            averageScoreDisplay.textContent = '0'; // 重置得分显示
            userVideo.play(); // 确保用户摄像头视频继续播放
        });

        // 确保用户视频在离开游戏页面后不会暂停，以便返回时能立即使用
        userVideo.addEventListener('pause', () => {
            if (isGameRunning) userVideo.play(); // 如果游戏正在进行，则保持播放
        });
        userVideo.addEventListener('ended', () => {
            if (isGameRunning) userVideo.play(); // 如果用户视频结束（不应该发生，但以防万一），重新播放
        });

        // 自动播放音乐
        window.addEventListener('DOMContentLoaded', () => {
            const audio = document.getElementById('bgm');
            if (audio) {
                audio.volume = 0.5;
                audio.play().catch(() => {
                    // 部分浏览器需用户交互后播放
                    document.body.addEventListener('click', () => audio.play(), { once: true });
                });
            }
        });
    </script>
</body>
</html>